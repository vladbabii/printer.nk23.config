[manual_stepper probe_mount]
step_pin: z:P0.19
dir_pin: z:P0.20
enable_pin: !z:P2.8
microsteps: 16
full_steps_per_rotation: 200
rotation_distance: 40
velocity: 10
accel: 5
endstop_pin: z:P1.26

[tmc2209 manual_stepper probe_mount]
uart_pin: z:P3.25
run_current: 1
stealthchop_threshold: 0

[gcode_macro PROBE_MOUNT_NOW]
variable_homed: 0
variable_position: -1
gcode:
  M118 ProbeMount

[gcode_macro PROBE_MOUNT_ON]
gcode:
  MANUAL_STEPPER STEPPER=probe_mount ENABLE=1

[gcode_macro PROBE_MOUNT_OFF]
gcode:
  MANUAL_STEPPER STEPPER=probe_mount ENABLE=0

[gcode_macro PROBE_MOUNT_HOME]
gcode:
  RESPOND PREFIX="info" MSG="ProbeMount > Homing..."
  PROBE_MOUNT_ON
  MANUAL_STEPPER STEPPER=probe_mount SET_POSITION=0 SPEED=3 MOVE=-14 STOP_ON_ENDSTOP=1
  MANUAL_STEPPER STEPPER=probe_mount SET_POSITION=0
  MANUAL_STEPPER STEPPER=probe_mount SPEED=3 MOVE=0.3
  SET_GCODE_VARIABLE MACRO=PROBE_MOUNT_NOW VARIABLE=homed VALUE=1

[gcode_macro PROBE_MOUNT_MOVE]
gcode:
  {% if params.POSITION is defined %}
    {% if printer['gcode_macro PROBE_MOUNT_NOW'].homed == 0 or params.POSITION == 0 %}
        PROBE_MOUNT_HOME
    {% elif params.POSITION>0 %}
      {% set speed=3 %}
      {% if params.SPEED is defined %}
        {% set speed = params.SPEED|int %}
      {% endif %}

      MANUAL_STEPPER STEPPER=probe_mount SPEED={speed} MOVE={params.POSITION|float}
      SET_GCODE_VARIABLE MACRO=PROBE_MOUNT_NOW VARIABLE=homed VALUE={params.POSITION|float}
    {% else %}
      RESPOND PREFIX="info" MSG="ProbeMount > ERROR > Position {params.POSITION|float} must be greater or equal to zero"
    {% endif %}

    
  {% else %}
    RESPOND PREFIX="info" MSG="ProbeMount > position parameter missing"
  {% endif %}